name: Run Tests and Lint

on:
  push:
    branches: [ Development, main ]
  pull_request:
    branches: [ Development, main ]

jobs:
  test-and-lint:
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8
        env:
          DB_BACKEND: mysql
          TEST_DB: mysql
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: scraping_db
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost -uroot -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov flake8 black

      - name: Set up config for CI
        run: cp environment/config.py.template environment/config.py

      - name: Initialize database schema
        run: python init_db.py

      - name: Install Playwright browsers
        run: playwright install --with-deps chromium

      - name: ğŸ§ª Run tests with pytest (MySQL)
        run: |
          export PYTHONPATH="${{ github.workspace }}"
          pytest --cov=scraper --cov=models --cov=link_extractor --cov=robots_handler \
                 --cov-report=xml tests/

      - name: ğŸ§¼ Run flake8 lint check
        run: |
          flake8 scraper.py models.py link_extractor.py robots_handler.py tests \
                 --max-line-length=88 --exclude=__init__.py

      - name: ğŸ¨ Run black formatting check
        run: |
          black --check scraper.py models.py link_extractor.py robots_handler.py tests

      - name: ğŸ“Š Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.xml
          flags: unittests
          name: scrape-pytest
          fail_ci_if_error: true
